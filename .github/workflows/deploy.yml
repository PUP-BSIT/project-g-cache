name: Deploy to Production

on:
  push:
    branches: ["main"]

env:
  FRONTEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/pomodify-frontend
  BACKEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/pomodify-backend
  TAG_LATEST: latest
  TAG_SHA: ${{ github.sha }}

jobs:
  build-and-push:
    name: Build and Push Production Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push frontend image
        run: |
          docker build -f pomodify-frontend/Dockerfile \
            -t $FRONTEND_IMAGE:$TAG_LATEST \
            -t $FRONTEND_IMAGE:$TAG_SHA \
            ./pomodify-frontend
          docker push $FRONTEND_IMAGE:$TAG_LATEST
          docker push $FRONTEND_IMAGE:$TAG_SHA

      - name: Install cosign
        run: |
          curl -sSL -o cosign https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
          chmod +x cosign

      - name: Sign frontend images with cosign
        env:
          COSIGN_KEY_B64: ${{ secrets.COSIGN_KEY_B64 }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "$COSIGN_KEY_B64" | base64 -d > cosign.key || true
          ./cosign sign --yes --key cosign.key $FRONTEND_IMAGE:$TAG_SHA
          ./cosign sign --yes --key cosign.key $FRONTEND_IMAGE:$TAG_LATEST
          rm -f cosign.key

      - name: Build and push backend image
        run: |
          docker build -f pomodify-backend/Dockerfile \
            -t $BACKEND_IMAGE:$TAG_LATEST \
            -t $BACKEND_IMAGE:$TAG_SHA \
            ./pomodify-backend
          docker push $BACKEND_IMAGE:$TAG_LATEST
          docker push $BACKEND_IMAGE:$TAG_SHA

      - name: Sign backend images with cosign
        env:
          COSIGN_KEY_B64: ${{ secrets.COSIGN_KEY_B64 }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "$COSIGN_KEY_B64" | base64 -d > cosign.key || true
          ./cosign sign --yes --key cosign.key $BACKEND_IMAGE:$TAG_SHA
          ./cosign sign --yes --key cosign.key $BACKEND_IMAGE:$TAG_LATEST
          rm -f cosign.key

  deploy-to-ec2:
    name: Deploy to EC2 Server
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Install cosign for verification
        run: |
          curl -sSL -o cosign https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
          chmod +x cosign

      - name: Verify image signatures before deploy
        env:
          COSIGN_PUBKEY_B64: ${{ secrets.COSIGN_PUBKEY_B64 }}
        run: |
          echo "$COSIGN_PUBKEY_B64" | base64 -d > cosign.pub || true
          ./cosign verify --key cosign.pub ${{ env.FRONTEND_IMAGE }}:${{ env.TAG_SHA }}
          ./cosign verify --key cosign.pub ${{ env.BACKEND_IMAGE }}:${{ env.TAG_SHA }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 180s
          script: |
            set -e

            echo "ğŸš€ Starting deployment to production..."
            
            # Verify required tools
            command -v docker >/dev/null 2>&1 || { echo "âŒ Docker is required but not installed."; exit 1; }
            command -v psql >/dev/null 2>&1 || { echo "âŒ PostgreSQL client is required but not installed."; exit 1; }

            # Stop old containers
            sudo docker stop pomodify-frontend pomodify-backend || true
            sudo docker rm pomodify-frontend pomodify-backend || true

            # Pull latest images
            echo "Pulling latest Docker images..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/pomodify-frontend:latest || { echo "âŒ Failed to pull frontend image"; exit 1; }
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/pomodify-backend:latest || { echo "âŒ Failed to pull backend image"; exit 1; }

            # Setup Firebase credentials if provided
            sudo mkdir -p /app
            if [ -n "${{ secrets.FCM_SERVICE_ACCOUNT_BASE64 }}" ]; then
              echo "Setting up Firebase credentials..."
              echo "${{ secrets.FCM_SERVICE_ACCOUNT_BASE64 }}" | base64 -d | sudo tee /app/firebase-key.json > /dev/null
              sudo chown root:root /app/firebase-key.json
              sudo chmod 600 /app/firebase-key.json
              FIREBASE_MOUNT="-v /app/firebase-key.json:/app/firebase-key.json:ro"
              FIREBASE_ENV="-e FCM_SERVICE_ACCOUNT=/app/firebase-key.json"
            else
              echo "âš ï¸  Firebase credentials not provided, FCM disabled"
              FIREBASE_MOUNT=""
              FIREBASE_ENV=""
            fi

            # Start frontend container
            echo "Starting frontend container..."
            # Ensure a user-defined network so containers can resolve each other by name
            sudo docker network create pomodify-net || true

            echo "Starting frontend container..."
            sudo docker run -d \
              --name pomodify-frontend \
              --network pomodify-net \
              --restart unless-stopped \
              -p 8080:80 \
              ${{ secrets.DOCKER_USERNAME }}/pomodify-frontend:latest || { echo "âŒ Failed to start frontend container"; exit 1; }

            # Wait for database to be ready before starting backend
            echo "Waiting for database to be ready..."
            retries=20
            until PGPASSWORD='${{ secrets.DB_PASSWORD }}' psql -h '${{ secrets.DB_HOST }}' -U '${{ secrets.DB_USERNAME }}' -d '${{ secrets.DB_NAME }}' -p '${{ secrets.DB_PORT }}' -c '\q' >/dev/null 2>&1; do
              retries=$((retries-1))
              if [ $retries -le 0 ]; then
                echo "âŒ Database not reachable after multiple attempts."
                echo "Check DB_HOST, DB_PORT, DB_USERNAME, DB_PASSWORD, and DB_NAME secrets."
                exit 1
              fi
              echo "Database not ready, retrying... ($retries attempts left)"
              sleep 5
            done
            echo "âœ… Database is ready"

            # Reset Flyway schema history (auto-fix migration issues)
            echo "Resetting Flyway schema history..."
            PGPASSWORD='${{ secrets.DB_PASSWORD }}' psql \
              -h '${{ secrets.DB_HOST }}' \
              -U '${{ secrets.DB_USERNAME }}' \
              -d '${{ secrets.DB_NAME }}' \
              -p '${{ secrets.DB_PORT }}' \
              -c "DROP TABLE IF EXISTS flyway_schema_history CASCADE;" || echo "âš ï¸  Flyway table not found (first deployment?)"
            echo "âœ… Flyway reset complete"

            # Start backend container
            echo "Starting backend container..."
            sudo docker run -d \
              --name pomodify-backend \
              --network pomodify-net \
              --restart unless-stopped \
              -p 8081:8081 \
              -e SPRING_PROFILES_ACTIVE='prod' \
              -e DB_URL='jdbc:postgresql://${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}/${{ secrets.DB_NAME }}' \
              -e DB_USERNAME='${{ secrets.DB_USERNAME }}' \
              -e DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
              -e DDL_AUTO='${{ secrets.DDL_AUTO }}' \
              -e SHOW_SQL='${{ secrets.SHOW_SQL }}' \
              -e JWT_SECRET='${{ secrets.JWT_SECRET }}' \
              -e JWT_ACCESS_EXPIRATION='${{ secrets.JWT_ACCESS_EXPIRATION }}' \
              -e JWT_REFRESH_TOKEN_EXPIRATION='${{ secrets.JWT_REFRESH_EXPIRATION }}' \
              -e GOOGLE_CLIENT_ID='${{ secrets.GOOGLE_CLIENT_ID }}' \
              -e GOOGLE_CLIENT_SECRET='${{ secrets.GOOGLE_CLIENT_SECRET }}' \
              -e SMTP_USERNAME='${{ secrets.SMTP_USERNAME }}' \
              -e SMTP_PASSWORD='${{ secrets.SMTP_PASSWORD }}' \
              -e GOOGLE_API_KEY='${{ secrets.GOOGLE_API_KEY }}' \
              $FIREBASE_ENV \
              $FIREBASE_MOUNT \
              ${{ secrets.DOCKER_USERNAME }}/pomodify-backend:latest || { echo "âŒ Failed to start backend container"; exit 1; }

            # Wait for backend to fully start
            echo "Waiting for backend to initialize (120 seconds)..."
            sleep 120  # give Spring Boot enough time for JPA initialization, servlet initialization, and SMTP configuration

            # Health check with retries for frontend
            echo "Checking frontend health..."
            retries=10
            until curl -f -s -m 5 http://localhost:8080 >/dev/null 2>&1; do
              retries=$((retries-1))
              if [ $retries -le 0 ]; then
                echo "âŒ Frontend health check failed after 10 retries"
                echo "Frontend container logs:"
                sudo docker logs pomodify-frontend | tail -30
                exit 1
              fi
              echo "â³ Frontend not ready, retrying... ($retries retries left)"
              sleep 3
            done
            echo "âœ… Frontend is healthy"

            # Health check with retries for backend - with detailed diagnostics
            echo "Checking backend health at http://localhost:8081/actuator/health..."
            retries=30
            until curl -f -s -m 5 http://localhost:8081/actuator/health 2>&1 | grep -q "UP\|status.*up" || wget --quiet --timeout=5 -O- http://localhost:8081/actuator/health 2>&1 | grep -q "UP\|status.*up"; do
              retries=$((retries-1))
              if [ $retries -le 0 ]; then
                echo "âŒ Backend health check failed after 30 retries"
                echo "Backend is still not responding to health checks."
                echo "Backend container logs (last 100 lines):"
                sudo docker logs pomodify-backend | tail -100
                echo ""
                echo "Checking if backend container is still running..."
                if sudo docker ps | grep -q pomodify-backend; then
                  echo "âœ“ Backend container is running"
                  echo ""
                  echo "Attempting direct HTTP request to backend:"
                  curl -v http://localhost:8081/actuator/health 2>&1 || echo "curl failed"
                else
                  echo "âœ— Backend container is NOT running!"
                fi
                exit 1
              fi
              echo "â³ Backend not ready, retrying... ($retries retries left)"
              sleep 3
            done
            echo "âœ… Backend is healthy and responding"

            # Restart nginx
            echo "Restarting nginx..."
            sudo systemctl restart nginx || true

            # Cleanup old images
            echo "Cleaning up old images..."
            sudo docker image prune -af --filter "until=24h" || true

            echo "âœ… Deployment completed successfully!"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ‰ DEPLOYMENT SUCCESSFUL"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Frontend: http://localhost:8080"
            echo "Backend:  http://localhost:8081"
            echo "Actuator: http://localhost:8081/actuator/health"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  verify-deployment:
    name: Deployment Summary
    needs: deploy-to-ec2
    runs-on: ubuntu-latest
    steps:
      - name: Show deployment summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰DEPLOYMENT SUCCESSFUL!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Frontend: http://localhost:8080"
          echo "Backend:  http://localhost:8081"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Deployed at: $(date -u)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
