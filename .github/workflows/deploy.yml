name: Deploy to Production

on:
  push:
    branches: ["main"]

env:
  FRONTEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/pomodify-frontend
  BACKEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/pomodify-backend
  TAG_LATEST: latest
  TAG_SHA: ${{ github.sha }}

jobs:
  build-and-push:
    name: Build and Push Production Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push frontend image
        run: |
          docker build -f pomodify-frontend/Dockerfile \
            -t $FRONTEND_IMAGE:$TAG_LATEST \
            -t $FRONTEND_IMAGE:$TAG_SHA \
            ./pomodify-frontend
          docker push $FRONTEND_IMAGE:$TAG_LATEST
          docker push $FRONTEND_IMAGE:$TAG_SHA

      - name: Install cosign
        run: |
          curl -sSL -o cosign https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
          chmod +x cosign

      - name: Sign frontend images with cosign
        env:
          COSIGN_KEY_B64: ${{ secrets.COSIGN_KEY_B64 }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "$COSIGN_KEY_B64" | base64 -d > cosign.key || true
          ./cosign sign --yes --key cosign.key $FRONTEND_IMAGE:$TAG_SHA
          ./cosign sign --yes --key cosign.key $FRONTEND_IMAGE:$TAG_LATEST
          rm -f cosign.key

      - name: Build and push backend image
        run: |
          docker build -f pomodify-backend/Dockerfile \
            -t $BACKEND_IMAGE:$TAG_LATEST \
            -t $BACKEND_IMAGE:$TAG_SHA \
            ./pomodify-backend
          docker push $BACKEND_IMAGE:$TAG_LATEST
          docker push $BACKEND_IMAGE:$TAG_SHA

      - name: Sign backend images with cosign
        env:
          COSIGN_KEY_B64: ${{ secrets.COSIGN_KEY_B64 }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "$COSIGN_KEY_B64" | base64 -d > cosign.key || true
          ./cosign sign --yes --key cosign.key $BACKEND_IMAGE:$TAG_SHA
          ./cosign sign --yes --key cosign.key $BACKEND_IMAGE:$TAG_LATEST
          rm -f cosign.key

  deploy-to-ec2:
    name: Deploy to EC2 Server
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Install cosign for verification
        run: |
          curl -sSL -o cosign https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
          chmod +x cosign

      - name: Verify image signatures before deploy
        env:
          COSIGN_PUBKEY_B64: ${{ secrets.COSIGN_PUBKEY_B64 }}
        run: |
          echo "$COSIGN_PUBKEY_B64" | base64 -d > cosign.pub || true
          ./cosign verify --key cosign.pub ${{ env.FRONTEND_IMAGE }}:${{ env.TAG_SHA }}
          ./cosign verify --key cosign.pub ${{ env.BACKEND_IMAGE }}:${{ env.TAG_SHA }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 600s
          command_timeout: 30m
          script: |
            set -e

            echo "ğŸš€ Starting deployment to production..."
            echo "Deployment started at: $(date)"
            
            # Verify required tools
            command -v docker >/dev/null 2>&1 || { echo "âŒ Docker is required but not installed."; exit 1; }
            command -v psql >/dev/null 2>&1 || { echo "âŒ PostgreSQL client is required but not installed."; exit 1; }

            # Stop old containers gracefully
            echo "Stopping old containers..."
            sudo docker stop pomodify-frontend pomodify-backend || true
            sudo docker rm pomodify-frontend pomodify-backend || true

            # Pull latest images
            echo "Pulling latest Docker images..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/pomodify-frontend:latest || { echo "âŒ Failed to pull frontend image"; exit 1; }
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/pomodify-backend:latest || { echo "âŒ Failed to pull backend image"; exit 1; }

            # Setup Firebase credentials if provided
            sudo mkdir -p /app
            if [ -n "${{ secrets.FCM_SERVICE_ACCOUNT_BASE64 }}" ]; then
              echo "Setting up Firebase credentials..."
              echo "${{ secrets.FCM_SERVICE_ACCOUNT_BASE64 }}" | base64 -d | sudo tee /app/firebase-key.json > /dev/null
              sudo chown root:root /app/firebase-key.json
              sudo chmod 600 /app/firebase-key.json
              FIREBASE_MOUNT="-v /app/firebase-key.json:/app/firebase-key.json:ro"
              FIREBASE_ENV="-e FCM_SERVICE_ACCOUNT=/app/firebase-key.json"
            else
              echo "âš ï¸  Firebase credentials not provided, FCM disabled"
              FIREBASE_MOUNT=""
              FIREBASE_ENV=""
            fi

            # Ensure Docker network exists
            echo "Setting up Docker network..."
            sudo docker network create pomodify-net || true

            # Start frontend container
            echo "Starting frontend container..."
            sudo docker run -d \
              --name pomodify-frontend \
              --network pomodify-net \
              --restart unless-stopped \
              -p 8080:80 \
              ${{ secrets.DOCKER_USERNAME }}/pomodify-frontend:latest || { echo "âŒ Failed to start frontend container"; exit 1; }

            # Wait for database to be ready
            echo "Waiting for database to be ready..."
            retries=30
            until PGPASSWORD='${{ secrets.DB_PASSWORD }}' psql -h '${{ secrets.DB_HOST }}' -U '${{ secrets.DB_USERNAME }}' -d '${{ secrets.DB_NAME }}' -p '${{ secrets.DB_PORT }}' -c '\q' >/dev/null 2>&1; do
              retries=$((retries-1))
              if [ $retries -le 0 ]; then
                echo "âŒ Database not reachable after multiple attempts."
                echo "Check DB_HOST, DB_PORT, DB_USERNAME, DB_PASSWORD, and DB_NAME secrets."
                exit 1
              fi
              echo "Database not ready, retrying... ($retries attempts left)"
              sleep 5
            done
            echo "âœ… Database is ready"

            # Start backend container - Flyway will handle migrations automatically
            echo "Starting backend container with Flyway migrations..."
            sudo docker run -d \
              --name pomodify-backend \
              --network pomodify-net \
              --restart unless-stopped \
              -p 8081:8081 \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e DB_URL=jdbc:postgresql://${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}/${{ secrets.DB_NAME }}?sslmode=require \
              -e DB_USERNAME=${{ secrets.DB_USERNAME }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e DDL_AUTO=update \
              -e SHOW_SQL=${{ secrets.SHOW_SQL }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e JWT_ACCESS_EXPIRATION=${{ secrets.JWT_ACCESS_EXPIRATION }} \
              -e JWT_REFRESH_EXPIRATION=${{ secrets.JWT_REFRESH_EXPIRATION }} \
              -e GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} \
              -e GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }} \
              -e SMTP_USERNAME=${{ secrets.SMTP_USERNAME }} \
              -e SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }} \
              -e GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }} \
              $FIREBASE_ENV \
              $FIREBASE_MOUNT \
              ${{ secrets.DOCKER_USERNAME }}/pomodify-backend:latest || { echo "âŒ Failed to start backend container"; exit 1; }

            # Wait for backend to initialize and run Flyway migrations
            echo "Waiting for backend to initialize (Flyway migrations + Spring Boot startup)..."
            echo "This may take 3-5 minutes for database migrations and application startup..."
            sleep 60
            
            # Show initial backend logs to verify startup
            echo ""
            echo "Backend startup logs (first 50 lines):"
            sudo docker logs pomodify-backend 2>&1 | head -50

            # Health check for frontend with detailed logging
            echo "Checking frontend health..."
            retries=15
            until curl -f -s -m 5 http://localhost:8080 >/dev/null 2>&1; do
              retries=$((retries-1))
              if [ $retries -le 0 ]; then
                echo "âŒ Frontend health check failed after 15 retries"
                echo "Frontend container logs (last 50 lines):"
                sudo docker logs pomodify-frontend | tail -50
                exit 1
              fi
              echo "â³ Frontend not ready, retrying... ($retries retries left)"
              sleep 3
            done
            echo "âœ… Frontend is healthy"

            # Health check for backend with detailed diagnostics
            echo "Checking backend health at http://localhost:8081/actuator/health..."
            retries=90
            until curl -f -s -m 5 http://localhost:8081/actuator/health 2>&1 | grep -q "UP\|status.*up" || wget --quiet --timeout=5 -O- http://localhost:8081/actuator/health 2>&1 | grep -q "UP\|status.*up"; do
              retries=$((retries-1))
              if [ $retries -le 0 ]; then
                echo "âŒ Backend health check failed after 90 retries"
                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "Backend Diagnostics"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                
                # Check if container is running
                echo ""
                echo "Container Status:"
                if sudo docker ps | grep -q pomodify-backend; then
                  echo "âœ“ Backend container is running"
                  sudo docker ps | grep pomodify-backend
                else
                  echo "âœ— Backend container is NOT running!"
                  sudo docker ps -a | grep pomodify-backend
                fi
                
                # Show backend logs
                echo ""
                echo "Backend Container Logs (last 200 lines):"
                echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                sudo docker logs pomodify-backend 2>&1 | tail -200
                
                # Check for specific error patterns
                echo ""
                echo "Error Analysis:"
                echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                sudo docker logs pomodify-backend 2>&1 | grep -i "error\|exception\|failed\|flyway" | tail -30
                
                # Try direct connection
                echo ""
                echo "Direct HTTP Test:"
                echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                curl -v http://localhost:8081/actuator/health 2>&1 || echo "curl failed"
                
                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                exit 1
              fi
              echo "â³ Backend not ready, retrying... ($retries retries left)"
              sleep 5
            done
            echo "âœ… Backend is healthy and responding"

            # Verify Flyway migrations were successful
            echo ""
            echo "Checking Flyway migration status..."
            FLYWAY_LOGS=$(sudo docker logs pomodify-backend 2>&1 | grep -i "flyway" | tail -20)
            if [ -n "$FLYWAY_LOGS" ]; then
              echo "Flyway Migration Logs:"
              echo "$FLYWAY_LOGS"
              
              if echo "$FLYWAY_LOGS" | grep -q "Successfully"; then
                echo "âœ… Flyway migrations completed successfully"
              else
                echo "âš ï¸  Flyway logs found but no success message detected"
              fi
            else
              echo "âš ï¸  No Flyway logs found in backend output"
            fi

            # Verify database schema
            echo ""
            echo "Verifying database schema..."
            SCHEMA_CHECK=$(PGPASSWORD='${{ secrets.DB_PASSWORD }}' psql -h '${{ secrets.DB_HOST }}' -U '${{ secrets.DB_USERNAME }}' -d '${{ secrets.DB_NAME }}' -p '${{ secrets.DB_PORT }}' -t -c "
              SELECT COUNT(*) FROM information_schema.tables 
              WHERE table_schema = 'public' 
              AND table_name IN ('app_user', 'activity', 'pomodoro_session', 'user_settings', 'user_badge');
            " 2>&1)
            
            if [ -n "$SCHEMA_CHECK" ]; then
              TABLE_COUNT=$(echo "$SCHEMA_CHECK" | tr -d ' ')
              echo "Found $TABLE_COUNT core tables in database"
              if [ "$TABLE_COUNT" -ge 5 ]; then
                echo "âœ… Core database tables verified"
              else
                echo "âš ï¸  Expected 5 core tables, found $TABLE_COUNT"
              fi
            fi

            # Check auth_provider column
            AUTH_PROVIDER_CHECK=$(PGPASSWORD='${{ secrets.DB_PASSWORD }}' psql -h '${{ secrets.DB_HOST }}' -U '${{ secrets.DB_USERNAME }}' -d '${{ secrets.DB_NAME }}' -p '${{ secrets.DB_PORT }}' -t -c "
              SELECT column_name FROM information_schema.columns 
              WHERE table_name = 'app_user' AND column_name = 'auth_provider';
            " 2>&1 | tr -d ' ')
            
            if [ "$AUTH_PROVIDER_CHECK" = "auth_provider" ]; then
              echo "âœ… auth_provider column exists in app_user table"
            else
              echo "âš ï¸  auth_provider column not found in app_user table"
            fi

            # Restart nginx to ensure it picks up new containers
            echo ""
            echo "Restarting nginx..."
            sudo systemctl restart nginx || true

            # Cleanup old Docker images
            echo ""
            echo "Cleaning up old Docker images..."
            sudo docker image prune -af --filter "until=24h" || true

            # Final verification
            echo ""
            echo "Performing final health checks..."
            FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
            BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/actuator/health)
            
            echo "Frontend HTTP Status: $FRONTEND_STATUS"
            echo "Backend HTTP Status: $BACKEND_STATUS"
            
            if [ "$FRONTEND_STATUS" = "200" ] && [ "$BACKEND_STATUS" = "200" ]; then
              echo "âœ… All services are responding correctly"
            else
              echo "âš ï¸  One or more services returned unexpected status codes"
            fi

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Deployment finished at: $(date)"
            echo ""
            echo "Service URLs:"
            echo "  Frontend: http://localhost:8080"
            echo "  Backend:  http://localhost:8081"
            echo "  Health:   http://localhost:8081/actuator/health"
            echo ""
            echo "Container Status:"
            sudo docker ps | grep pomodify
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  verify-deployment:
    name: Deployment Summary
    needs: deploy-to-ec2
    runs-on: ubuntu-latest
    steps:
      - name: Show deployment summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Deployment Details:"
          echo "  Commit SHA:    ${{ github.sha }}"
          echo "  Deployed by:   ${{ github.actor }}"
          echo "  Deployed at:   $(date -u)"
          echo "  Branch:        ${{ github.ref_name }}"
          echo ""
          echo "Images Deployed:"
          echo "  Frontend: ${{ env.FRONTEND_IMAGE }}:${{ env.TAG_SHA }}"
          echo "  Backend:  ${{ env.BACKEND_IMAGE }}:${{ env.TAG_SHA }}"
          echo ""
          echo "Service Endpoints:"
          echo "  Frontend: http://your-domain:8080"
          echo "  Backend:  http://your-domain:8081"
          echo ""
          echo "Migrations Applied: V1-V9 (Flyway)"
          echo "  âœ“ V1: Initial schema"
          echo "  âœ“ V2: User push token enabled"
          echo "  âœ“ V3: User settings table"
          echo "  âœ“ V4: User badge table"
          echo "  âœ“ V5: Timer sync fields"
          echo "  âœ“ V6: Remove tick sound"
          echo "  âœ“ V7: Remove calendar sync"
          echo "  âœ“ V8: Add auth provider"
          echo "  âœ“ V9: Pomodoro session table"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"