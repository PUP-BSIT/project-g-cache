name: CI - Build and Test

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]

env:
  FRONTEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/pomodify-frontend
  BACKEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/pomodify-backend
  TAG_PR: pr-${{ github.event.pull_request.number }}

jobs:
  lint-and-validate:
    name: Lint and Validate Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Dockerfiles
        run: |
          echo "âœ… Validating frontend Dockerfile..."
          if [ -f pomodify-frontend/Dockerfile ]; then
            echo "Frontend Dockerfile found"
          else
            echo "âŒ Frontend Dockerfile not found!"
            exit 1
          fi
          
          echo "âœ… Validating backend Dockerfile..."
          if [ -f pomodify-backend/Dockerfile ]; then
            echo "Backend Dockerfile found"
          else
            echo "âŒ Backend Dockerfile not found!"
            exit 1
          fi

      - name: Check for merge conflicts
        run: |
          git fetch origin main
          if git merge-base --is-ancestor origin/main HEAD; then
            echo "âœ… No conflicts with main branch"
          else
            echo "âš ï¸ Branch might have conflicts with main"
          fi

  build-and-test:
    name: Build and Test Docker Images
    needs: [lint-and-validate, unit-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build frontend image
        run: |
          echo "ğŸ”¨ Building frontend Docker image..."
          docker build -f pomodify-frontend/Dockerfile \
            -t $FRONTEND_IMAGE:$TAG_PR \
            ./pomodify-frontend
          echo "âœ… Frontend image built successfully!"

      - name: Build backend image
        run: |
          echo "ğŸ”¨ Building backend Docker image..."
          docker build -f pomodify-backend/Dockerfile \
            -t $BACKEND_IMAGE:$TAG_PR \
            ./pomodify-backend
          echo "âœ… Backend image built successfully!"

      - name: Test frontend image
        run: |
          echo "ğŸ§ª Testing frontend container..."
          docker run -d --name test-frontend -p 8080:80 $FRONTEND_IMAGE:$TAG_PR
          sleep 5
          if docker ps | grep -q test-frontend; then
            echo "âœ… Frontend container started successfully!"
            docker stop test-frontend
            docker rm test-frontend
          else
            echo "âŒ Frontend container failed to start!"
            docker logs test-frontend || true
            exit 1
          fi

      - name: Test backend image
        run: |
          echo "ğŸ§ª Testing backend container..."
          docker run -d --name test-backend \
            -p 8081:8081 \
            -e DB_HOST="pomodifydb.cvwkscysw9h2.ap-southeast-2.rds.amazonaws.com" \
            -e DB_PORT="5432" \
            -e DB_NAME="pomodifydb" \
            -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            -e DB_URL="jdbc:postgresql://pomodifydb.cvwkscysw9h2.ap-southeast-2.rds.amazonaws.com:5432/pomodifydb" \
            -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            $BACKEND_IMAGE:$TAG_PR
          sleep 15
          if docker ps | grep -q test-backend; then
            echo "âœ… Backend container started successfully!"
            docker logs test-backend
            docker stop test-backend
            docker rm test-backend
          else
            echo "âŒ Backend container failed to start!"
            docker logs test-backend || true
            exit 1
          fi

    build-and-secure:
      name: Build, SBOM, Scan & Sign
      needs: build-and-test
      runs-on: ubuntu-latest
      env:
        REGISTRY: ${{ secrets.DOCKER_USERNAME }}
        TAG_PR: ${{ env.TAG_PR }}
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

    unit-tests:
      name: Unit Tests (Frontend + Backend)
      needs: lint-and-validate
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'

        - name: Install frontend dependencies
          working-directory: ./pomodify-frontend
          run: npm ci

        - name: Run frontend unit tests (Karma)
          working-directory: ./pomodify-frontend
          run: npx ng test --watch=false --browsers=ChromeHeadless --no-progress

        - name: Setup Java
          uses: actions/setup-java@v4
          with:
            distribution: 'temurin'
            java-version: '21'

        - name: Run backend unit tests
          working-directory: ./pomodify-backend
          run: mvn -B -DskipITs test

        - name: Set up QEMU
          uses: docker/setup-qemu-action@v3

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Build and push backend image (temporary tag)
          run: |
            docker build -f pomodify-backend/Dockerfile -t $REGISTRY/pomodify-backend:$TAG_PR ./pomodify-backend
            docker push $REGISTRY/pomodify-backend:$TAG_PR

        - name: Build and push frontend image (temporary tag)
          run: |
            docker build -f pomodify-frontend/Dockerfile -t $REGISTRY/pomodify-frontend:$TAG_PR ./pomodify-frontend
            docker push $REGISTRY/pomodify-frontend:$TAG_PR

        - name: Generate SBOM for backend image
          uses: anchore/syft-action@v0.11.0
          with:
            image: ${{ env.REGISTRY }}/pomodify-backend:${{ env.TAG_PR }}

        - name: Scan backend image with Trivy
          uses: aquasecurity/trivy-action@v0.12.0
          with:
            image-ref: ${{ env.REGISTRY }}/pomodify-backend:${{ env.TAG_PR }}
            format: 'table'
            exit-code: '1'
            severity: 'CRITICAL,HIGH'

        - name: Install cosign
          run: |
            curl -sSL -o cosign https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
            chmod +x cosign

        - name: Sign backend image with cosign
          env:
            COSIGN_KEY_B64: ${{ secrets.COSIGN_KEY_B64 }}
          run: |
            echo "$COSIGN_KEY_B64" | base64 -d > cosign.key || true
            ./cosign sign --key cosign.key ${{ env.REGISTRY }}/pomodify-backend:${{ env.TAG_PR }}

        - name: Sign frontend image with cosign
          env:
            COSIGN_KEY_B64: ${{ secrets.COSIGN_KEY_B64 }}
          run: |
            echo "$COSIGN_KEY_B64" | base64 -d > cosign.key || true
            ./cosign sign --key cosign.key ${{ env.REGISTRY }}/pomodify-frontend:${{ env.TAG_PR }}

  ci-summary:
    name: CI Summary
    needs: [lint-and-validate, build-and-test, build-and-secure]
    runs-on: ubuntu-latest
    steps:
      - name: CI Passed
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… All CI checks passed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Summary:"
          echo "  âœ… Linting and validation - Passed"
          echo "  âœ… Docker builds - Passed"
          echo "  âœ… Container tests - Passed"
          echo ""
          echo "ğŸ‰ This PR is ready to be merged into main!"
          echo "ğŸš€ Deployment will start automatically after merge"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
