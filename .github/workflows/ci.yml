name: CI - Build and Test

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, synchronize, reopened ]

env:
  FRONTEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/pomodify-frontend
  BACKEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/pomodify-backend
  TAG_PR: pr-${{ github.event.pull_request.number }}

jobs:
  lint-and-validate:
    name: Lint and Validate Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Dockerfiles
        run: |
          echo "âœ… Validating frontend Dockerfile..."
          if [ -f pomodify-frontend/Dockerfile ]; then
            echo "Frontend Dockerfile found"
          else
            echo "âŒ Frontend Dockerfile not found!"
            exit 1
          fi
          
          echo "âœ… Validating backend Dockerfile..."
          if [ -f pomodify-backend/Dockerfile ]; then
            echo "Backend Dockerfile found"
          else
            echo "âŒ Backend Dockerfile not found!"
            exit 1
          fi

      - name: Check for merge conflicts
        run: |
          git fetch origin main
          if git merge-base --is-ancestor origin/main HEAD; then
            echo "âœ… No conflicts with main branch"
          else
            echo "âš ï¸ Branch might have conflicts with main"
          fi

  build-and-test:
    name: Build and Test Docker Images
    needs: lint-and-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build frontend image
        run: |
          echo "ğŸ”¨ Building frontend Docker image..."
          docker build -f pomodify-frontend/Dockerfile \
            -t $FRONTEND_IMAGE:$TAG_PR \
            ./pomodify-frontend
          echo "âœ… Frontend image built successfully!"

      - name: Build backend image
        run: |
          echo "ğŸ”¨ Building backend Docker image..."
          docker build -f pomodify-backend/Dockerfile \
            -t $BACKEND_IMAGE:$TAG_PR \
            ./pomodify-backend
          echo "âœ… Backend image built successfully!"

      - name: Test frontend image
        run: |
          echo "ğŸ§ª Testing frontend container..."
          docker run -d --name test-frontend -p 8080:80 $FRONTEND_IMAGE:$TAG_PR
          sleep 5
          if docker ps | grep -q test-frontend; then
            echo "âœ… Frontend container started successfully!"
            docker stop test-frontend
            docker rm test-frontend
          else
            echo "âŒ Frontend container failed to start!"
            exit 1
          fi

      - name: Test backend image
        run: |
          echo "ğŸ§ª Testing backend container..."
          docker run -d --name test-backend \
            -p 8081:8081 \
            -e DB_URL="jdbc:postgresql://localhost:5432/test" \
            -e DB_USERNAME="test" \
            -e DB_PASSWORD="test" \
            -e JWT_SECRET="test-secret-key-minimum-32-characters-long" \
            $BACKEND_IMAGE:$TAG_PR
          sleep 10
          if docker ps | grep -q test-backend; then
            echo "âœ… Backend container started successfully!"
            docker logs test-backend
            docker stop test-backend
            docker rm test-backend
          else
            echo "âŒ Backend container failed to start!"
            docker logs test-backend || true
            exit 1
          fi

  ci-summary:
    name: CI Summary
    needs: [lint-and-validate, build-and-test]
    runs-on: ubuntu-latest
    steps:
      - name: CI Passed
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… All CI checks passed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Summary:"
          echo "  âœ… Linting and validation - Passed"
          echo "  âœ… Docker builds - Passed"
          echo "  âœ… Container tests - Passed"
          echo ""
          echo "ğŸ‰ This PR is ready to be merged into main!"
          echo "ğŸš€ Deployment will start automatically after merge"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"