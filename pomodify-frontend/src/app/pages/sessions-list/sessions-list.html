<div class="sessions-list-container">
  <header class="sessions-header">
    <button class="back-btn" (click)="router.navigate(['/activities'])">
      <i class="fa-solid fa-arrow-left"></i>
      Back
    </button>
    <h1>{{ activityTitle() }}</h1>
    <div class="header-actions" style="display: flex; gap: 10px;">
      <button class="toggle-abandoned-btn" (click)="toggleAbandoned()">
        {{ showAbandoned() ? 'Hide Abandoned' : 'Show Abandoned' }}
      </button>
      <button class="create-session-btn" (click)="onCreateSessionClick()" [style.opacity]="hasActiveSession() ? '0.5' : '1'">
        <i class="fa-solid fa-plus"></i>
        New Session
      </button>
    </div>
  </header>

  @if (loading()) {
    <div class="loading-state">
      <i class="fa-solid fa-spinner fa-spin"></i>
      <p>Loading sessions...</p>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <i class="fa-solid fa-exclamation-circle"></i>
      <p>{{ error() }}</p>
      <button (click)="loadSessions()">Retry</button>
    </div>
  } @else if (sessions().length === 0) {
    <div class="empty-state">
      <i class="fa-solid fa-clock"></i>
      <h3>No sessions yet</h3>
      <p>Create your first pomodoro session to get started!</p>
      <button class="create-first-btn" (click)="createNewSession()">
        <i class="fa-solid fa-plus"></i>
        Create Session
      </button>
    </div>
  } @else {
    <!-- Active Sessions (PENDING, IN_PROGRESS, PAUSED) -->
    @if (activeSessions().length > 0) {
      <section class="sessions-section">
        <h2 class="section-title">
          <i class="fa-solid fa-play-circle"></i>
          Active Sessions
        </h2>
        <div class="sessions-grid">
          @for (session of activeSessions(); track session.id) {
            <div class="session-card" (click)="openSession(session)">
              <!-- Colored Header Section -->
              <div class="card-header" [ngStyle]="getSessionCardStyle()">
                <div class="header-content">
                  <div class="session-icon">
                    <i class="fa-solid fa-stopwatch"></i>
                  </div>
                  <div class="session-title-area">
                    <h3 class="session-type-name">{{ session.sessionType }}</h3>
                    <span class="session-date">
                      <i class="fa-regular fa-calendar"></i>
                      {{ formatDate(session.createdAt) }}
                    </span>
                  </div>
                </div>
                <span class="session-status" [ngClass]="getStatusClass(getEffectiveStatus(session))">
                  @switch (getEffectiveStatus(session)) {
                    @case ('NOT_STARTED') { <i class="fa-solid fa-circle"></i> Ready }
                    @case ('IN_PROGRESS') { <i class="fa-solid fa-play"></i> Running }
                    @case ('PAUSED') { <i class="fa-solid fa-pause"></i> Paused }
                    @default { {{ getEffectiveStatus(session) }} }
                  }
                </span>
                <!-- Decorative circles -->
                <div class="header-decoration">
                  <div class="circle circle-1"></div>
                  <div class="circle circle-2"></div>
                  <div class="circle circle-3"></div>
                </div>
              </div>
              
              <!-- White Body Section -->
              <div class="card-body">
                <!-- Stats Grid -->
                <div class="stats-grid">
                  <div class="stat-item">
                    <i class="fa-solid fa-crosshairs"></i>
                    <div class="stat-content">
                      <span class="stat-label">Focus</span>
                      <span class="stat-value">{{ session.focusTimeInMinutes }}m</span>
                    </div>
                  </div>
                  <div class="stat-item">
                    <i class="fa-solid fa-mug-hot"></i>
                    <div class="stat-content">
                      <span class="stat-label">Break</span>
                      <span class="stat-value">{{ session.breakTimeInMinutes }}m</span>
                    </div>
                  </div>
                  <div class="stat-item">
                    <i class="fa-solid fa-rotate"></i>
                    <div class="stat-content">
                      <span class="stat-label">Cycles</span>
                      <span class="stat-value">{{ session.cyclesCompleted }}/{{ session.cycles }}</span>
                    </div>
                  </div>
                  <div class="stat-item">
                    <i class="fa-solid fa-flag"></i>
                    <div class="stat-content">
                      <span class="stat-label">Phase</span>
                      <span class="stat-value">{{ session.currentPhase }}</span>
                    </div>
                  </div>
                </div>

                <!-- Notes Preview -->
                <div class="notes-section">
                  <div class="notes-header">
                    <i class="fa-solid fa-note-sticky"></i>
                    <span>Notes</span>
                  </div>
                  <p class="notes-text">{{ getNoteText(session.note) || 'No notes for this session' }}</p>
                </div>

                <!-- Action Button -->
                <button class="btn-continue" [ngStyle]="{'background': getSessionCardStyle()['background']}">
                  <i class="fa-solid fa-play"></i>
                  Continue Session
                </button>
              </div>
            </div>
          }
        </div>
      </section>
    }

    <!-- Completed Sessions with Pagination -->
    @if (allCompletedSessions().length > 0) {
      <section class="sessions-section">
        <h2 class="section-title">
          <i class="fa-solid fa-check-circle"></i>
          Completed Sessions
          <span class="section-count">({{ allCompletedSessions().length }})</span>
        </h2>
        <div class="sessions-grid">
          @for (session of completedSessions(); track session.id) {
            <div class="session-card completed">
              <!-- Colored Header Section -->
              <div class="card-header" [ngStyle]="getSessionCardStyle()">
                <div class="header-content">
                  <div class="session-icon">
                    <i class="fa-solid fa-trophy"></i>
                  </div>
                  <div class="session-title-area">
                    <h3 class="session-type-name">{{ session.sessionType }}</h3>
                    <span class="session-date">
                      <i class="fa-regular fa-calendar"></i>
                      {{ formatDate(session.createdAt) }}
                    </span>
                  </div>
                </div>
                <span class="session-status" [ngClass]="getStatusClass(session.status)">
                  <i class="fa-solid fa-check"></i>
                  Done
                </span>
                <!-- Decorative circles -->
                <div class="header-decoration">
                  <div class="circle circle-1"></div>
                  <div class="circle circle-2"></div>
                  <div class="circle circle-3"></div>
                </div>
              </div>
              
              <!-- White Body Section -->
              <div class="card-body">
                <!-- Stats Grid -->
                <div class="stats-grid">
                  <div class="stat-item">
                    <i class="fa-solid fa-crosshairs"></i>
                    <div class="stat-content">
                      <span class="stat-label">Focus</span>
                      <span class="stat-value">{{ session.focusTimeInMinutes }}m</span>
                    </div>
                  </div>
                  <div class="stat-item">
                    <i class="fa-solid fa-mug-hot"></i>
                    <div class="stat-content">
                      <span class="stat-label">Break</span>
                      <span class="stat-value">{{ session.breakTimeInMinutes }}m</span>
                    </div>
                  </div>
                  <div class="stat-item">
                    <i class="fa-solid fa-rotate"></i>
                    <div class="stat-content">
                      <span class="stat-label">Cycles</span>
                      <span class="stat-value">{{ session.cyclesCompleted }}/{{ session.cycles }}</span>
                    </div>
                  </div>
                  <div class="stat-item completed-badge">
                    <i class="fa-solid fa-medal"></i>
                    <div class="stat-content">
                      <span class="stat-label">Status</span>
                      <span class="stat-value success">Complete!</span>
                    </div>
                  </div>
                </div>

                <!-- Notes Preview -->
                <div class="notes-section">
                  <div class="notes-header">
                    <i class="fa-solid fa-note-sticky"></i>
                    <span>Notes</span>
                  </div>
                  <p class="notes-text">{{ getNoteText(session.note) || 'No notes for this session' }}</p>
                </div>

                <!-- Completed Info -->
                @if (session.updatedAt) {
                  <div class="completed-info">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span>Completed {{ formatDate(session.updatedAt) }}</span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
        
        <!-- Completed Pagination -->
        @if (completedTotalPages() > 1) {
          <div class="pagination">
            <!-- Previous Page Button -->
            <button 
              class="pagination-btn" 
              [disabled]="completedPage() === 1"
              (click)="goToCompletedPage(completedPage() - 1)">
              <i class="fa-solid fa-chevron-left"></i>
            </button>
            
            <!-- Page Numbers with Smart Truncation -->
            @for (page of completedVisiblePages(); track $index) {
              @if (page === '...') {
                <span class="pagination-ellipsis">...</span>
              } @else {
                <button 
                  class="pagination-btn" 
                  [class.active]="completedPage() === page"
                  (click)="navigateCompletedPage(page)">
                  {{ page }}
                </button>
              }
            }

            <!-- Next Page Button -->
            <button 
              class="pagination-btn" 
              [disabled]="completedPage() === completedTotalPages()"
              (click)="goToCompletedPage(completedPage() + 1)">
              <i class="fa-solid fa-chevron-right"></i>
            </button>
          </div>
        }
      </section>
    }

    <!-- Abandoned Sessions with Pagination -->
    @if (showAbandoned() && allAbandonedSessions().length > 0) {
      <section class="sessions-section abandoned-section">
        <h2 class="section-title">
          <i class="fa-solid fa-ban"></i>
          Abandoned Sessions
          <span class="section-count">({{ allAbandonedSessions().length }})</span>
        </h2>
        <div class="sessions-grid">
          @for (session of abandonedSessions(); track session.id) {
            <div class="session-card abandoned">
              <!-- Gray Header Section for Abandoned -->
              <div class="card-header abandoned-header">
                <div class="header-content">
                  <div class="session-icon">
                    <i class="fa-solid fa-ghost"></i>
                  </div>
                  <div class="session-title-area">
                    <h3 class="session-type-name">{{ session.sessionType }}</h3>
                    <span class="session-date">
                      <i class="fa-regular fa-calendar"></i>
                      {{ formatDate(session.createdAt) }}
                    </span>
                  </div>
                </div>
                <span class="session-status status-abandoned">
                  <i class="fa-solid fa-ban"></i>
                  Abandoned
                </span>
                <!-- Decorative circles -->
                <div class="header-decoration">
                  <div class="circle circle-1"></div>
                  <div class="circle circle-2"></div>
                  <div class="circle circle-3"></div>
                </div>
              </div>
              
              <!-- White Body Section -->
              <div class="card-body">
                <!-- Stats Grid -->
                <div class="stats-grid">
                  <div class="stat-item">
                    <i class="fa-solid fa-crosshairs"></i>
                    <div class="stat-content">
                      <span class="stat-label">Focus</span>
                      <span class="stat-value">{{ session.focusTimeInMinutes }}m</span>
                    </div>
                  </div>
                  <div class="stat-item">
                    <i class="fa-solid fa-mug-hot"></i>
                    <div class="stat-content">
                      <span class="stat-label">Break</span>
                      <span class="stat-value">{{ session.breakTimeInMinutes }}m</span>
                    </div>
                  </div>
                  <div class="stat-item">
                    <i class="fa-solid fa-rotate"></i>
                    <div class="stat-content">
                      <span class="stat-label">Cycles</span>
                      <span class="stat-value">{{ session.cyclesCompleted }}/{{ session.cycles }}</span>
                    </div>
                  </div>
                  <div class="stat-item">
                    <i class="fa-solid fa-flag"></i>
                    <div class="stat-content">
                      <span class="stat-label">Phase</span>
                      <span class="stat-value">{{ session.currentPhase }}</span>
                    </div>
                  </div>
                </div>

                <!-- Notes Preview -->
                <div class="notes-section">
                  <div class="notes-header">
                    <i class="fa-solid fa-note-sticky"></i>
                    <span>Notes</span>
                  </div>
                  <p class="notes-text">{{ getNoteText(session.note) || 'No notes for this session' }}</p>
                </div>
              </div>
            </div>
          }
        </div>
        
        <!-- Abandoned Pagination -->
        @if (abandonedTotalPages() > 1) {
          <div class="pagination">
            <!-- Previous Page Button -->
            <button 
              class="pagination-btn" 
              [disabled]="abandonedPage() === 1"
              (click)="goToAbandonedPage(abandonedPage() - 1)">
              <i class="fa-solid fa-chevron-left"></i>
            </button>
            
            <!-- Page Numbers with Smart Truncation -->
            @for (page of abandonedVisiblePages(); track $index) {
              @if (page === '...') {
                <span class="pagination-ellipsis">...</span>
              } @else {
                <button 
                  class="pagination-btn" 
                  [class.active]="abandonedPage() === page"
                  (click)="navigateAbandonedPage(page)">
                  {{ page }}
                </button>
              }
            }

            <!-- Next Page Button -->
            <button 
              class="pagination-btn" 
              [disabled]="abandonedPage() === abandonedTotalPages()"
              (click)="goToAbandonedPage(abandonedPage() + 1)">
              <i class="fa-solid fa-chevron-right"></i>
            </button>
          </div>
        }
      </section>
    }

    <!-- Empty state when no sessions match current view -->
    @if (activeSessions().length === 0 && allCompletedSessions().length === 0 && (!showAbandoned() || allAbandonedSessions().length === 0)) {
      <div class="empty-state">
        <i class="fa-solid fa-clock"></i>
        <h3>No sessions to display</h3>
        <p>Create a new session to get started!</p>
      </div>
    }
  }
</div>
