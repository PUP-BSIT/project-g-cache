<div class="profile-modal">
  <!-- Header -->
  <div class="modal-header">
    <h2>Profile Settings</h2>
    <button class="close-btn" (click)="onClose()" aria-label="Close profile">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <!-- Content -->
  <div class="modal-content">
    @if (isLoadingProfile()) {
      <div class="loading-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
        <div class="spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 15px; color: #666;">Loading profile...</p>
      </div>
      <style>
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      </style>
    } @else {
    <!-- Profile Picture Section -->
    <div class="profile-picture-section">
      <div class="avatar-container">
        <img [src]="profileImage()" alt="Profile picture" class="avatar" />
        <button class="edit-avatar-btn" (click)="triggerImageUpload()" aria-label="Change profile picture">
          <i class="fa-solid fa-pen"></i>
        </button>
        <input 
          #profileImageInput
          type="file" 
          id="profile-image-input" 
          accept="image/*" 
          (change)="onImageUpload($event)"
          style="display: none;"
        />
      </div>
      <div class="profile-info-header">
        <h3>{{ userName() }}</h3>
        <p class="email-text">{{ userEmail() }}</p>
      </div>
    </div>

    <!-- Badges Section -->
    @if (badges().length > 0) {
      <div class="badges-section">
        <div class="badges-header">
          <h4>Achievements</h4>
          <span class="badge-count">{{ badges().length }}</span>
        </div>
        <div class="badges-grid">
          @for (badge of badges(); track badge.id) {
            <div class="badge-item">
              <img [src]="badge.imageUrl" [alt]="badge.name" class="badge-image" />
              <span class="badge-name">{{ badge.name }}</span>
              <div class="badge-tooltip">
                <div class="tooltip-title">{{ badge.name }}</div>
                <div class="tooltip-milestone">{{ badge.milestoneDays }} days milestone</div>
                <div class="tooltip-date">Earned on {{ badge.dateAwarded }}</div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Divider -->
    <div class="divider"></div>

    <!-- Name Section -->
    <div class="form-section">
      <label class="section-label">Name</label>
      <form [formGroup]="profileForm" class="inline-form">
        <input 
          type="text" 
          formControlName="name" 
          class="form-input"
          placeholder="Enter your name"
        />
        <button 
          type="button"
          class="btn-save-inline"
          (click)="updateName()"
          [disabled]="profileForm.invalid || profileForm.pristine || isSavingName()"
        >
          {{ isSavingName() ? 'Saving...' : 'Save' }}
        </button>
      </form>
    </div>

    <!-- Email Section (Read-only) -->
    <div class="form-section">
      <label class="section-label">Email account</label>
      <div class="email-display">
        <input 
          type="text" 
          [value]="userEmail()" 
          class="form-input"
          disabled
        />
        <span class="info-badge">Not editable</span>
      </div>
    </div>

    <!-- Backup Email Section -->
    <div class="form-section backup-email-section">
      <label class="section-label">Backup Email</label>
      
      @if (backupEmail()) {
        <form [formGroup]="backupEmailForm" class="inline-form">
          <input 
            type="email" 
            formControlName="backupEmail" 
            [value]="backupEmail()"
            class="form-input"
            placeholder="Email address"
            autocomplete="off"
          />
          <button 
            type="button"
            class="btn-save-inline"
            (click)="updateBackupEmail()"
            [disabled]="backupEmailForm.invalid || backupEmailForm.pristine || isSavingBackupEmail()"
          >
            {{ isSavingBackupEmail() ? 'Saving...' : 'Update' }}
          </button>
        </form>
      }

      @if (!backupEmail() && !showBackupEmailForm()) {
        <button class="btn-add-backup-email" (click)="toggleBackupEmailForm()">
          <i class="fa-solid fa-plus"></i>
          Add backup email
        </button>
      }

      @if (showBackupEmailForm() && !backupEmail()) {
        <form [formGroup]="backupEmailForm" class="backup-email-form">
          <input 
            type="email" 
            formControlName="backupEmail" 
            class="form-input"
            placeholder="Enter backup email address"
            autocomplete="off"
          />
          <div class="form-actions-inline">
            <button 
              type="button"
              class="btn-secondary-small"
              (click)="toggleBackupEmailForm()"
              [disabled]="isSavingBackupEmail()"
            >
              Cancel
            </button>
            <button 
              type="button"
              class="btn-primary-small"
              (click)="saveBackupEmail()"
              [disabled]="backupEmailForm.invalid || isSavingBackupEmail()"
            >
              {{ isSavingBackupEmail() ? 'Saving...' : 'Save' }}
            </button>
          </div>
        </form>
      }
      
      <p class="helper-text">
        This email will be used for account recovery if you lose access to your primary email
      </p>
    </div>

    <!-- Password Section -->
    <div class="form-section">
      <label class="section-label">Password</label>
      
      @if (!showPasswordVerification()) {
        <div class="password-display">
          <input 
            type="password" 
            value="••••••••••••" 
            class="form-input"
            disabled
          />
          <button 
            class="btn-change-password"
            (click)="requestPasswordChange()"
          >
            Change Password
          </button>
        </div>
      }

      <!-- Password Change Form -->
      @if (showPasswordVerification()) {
        <div class="password-change-container">
          <!-- Success Message -->
          @if (passwordChangeSuccess()) {
            <div class="success-message">
              <i class="fa-solid fa-check-circle"></i>
              <span>Password updated successfully!</span>
            </div>
          }
          
          <!-- Error Message -->
          @if (passwordChangeError()) {
            <div class="error-message">
              <i class="fa-solid fa-exclamation-circle"></i>
              <span>{{ passwordChangeError() }}</span>
            </div>
          }
          
          <form [formGroup]="passwordForm" class="password-form">
            <div class="form-group">
              <label>Current Password</label>
              <input 
                type="password" 
                formControlName="currentPassword" 
                class="form-input"
                placeholder="Enter current password"
                autocomplete="current-password"
              />
            </div>
            
            <div class="form-group">
              <label>New Password</label>
              <input 
                type="password" 
                formControlName="newPassword" 
                class="form-input"
                placeholder="Min 8 characters"
                autocomplete="new-password"
              />
            </div>
            
            <div class="form-group">
              <label>Confirm New Password</label>
              <input 
                type="password" 
                formControlName="confirmPassword" 
                class="form-input"
                placeholder="Re-enter new password"
                autocomplete="new-password"
              />
            </div>
            
            <div class="form-actions">
              <button 
                type="button"
                class="btn-secondary"
                (click)="cancelPasswordChange()"
                [disabled]="isChangingPassword()"
              >
                Cancel
              </button>
              <button 
                type="button"
                class="btn-primary"
                (click)="submitPasswordChange()"
                [disabled]="passwordForm.invalid || isChangingPassword()"
              >
                {{ isChangingPassword() ? 'Updating...' : 'Update Password' }}
              </button>
            </div>
          </form>
        </div>
      }
    </div>
    }
  </div>

  <!-- Footer Actions -->
  <div class="modal-footer">
    <button class="btn-cancel-modal" (click)="onClose()">
      Cancel
    </button>
    <button class="btn-save-modal" (click)="onSaveChanges()">
      Save Changes
    </button>
  </div>
</div>
