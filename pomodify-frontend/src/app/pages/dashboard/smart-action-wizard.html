@if (open) {
  <div class="wizard-modal">
    <div class="wizard-content" [class.wide]="state() === 'preview'">
      <button type="button" class="close-btn" (click)="close()">×</button>
      
      @switch (state()) {
        @case ('idle') {
          <form (ngSubmit)="startGeneration()">
            <h2>What do you want to focus on?</h2>
            <textarea 
              #topicTextarea
              [(ngModel)]="topic" 
              name="topic" 
              maxlength="200" 
              placeholder="e.g. Coding, Writing, Learning..." 
              required
              (input)="onTopicInput($event)"
              class="auto-expand-textarea">
            </textarea>
            <button type="submit" [disabled]="!topic().trim()">Generate Plans <i class="fa-solid fa-wand-magic-sparkles"></i></button>
          </form>
        }
        
        @case ('generating') {
          <div class="generating-state">
            <div class="magic-loader">
              <div class="sparkle sparkle-1">✦</div>
              <div class="sparkle sparkle-2">✧</div>
              <div class="sparkle sparkle-3">✦</div>
              <div class="loading-spinner"></div>
            </div>
            <p class="generating-text">Crafting personalized plans...</p>
          </div>
        }
        
        @case ('preview') {
          <div class="preview-container">
            <h2 class="preview-title">Choose Your Path</h2>
            <p class="preview-subtitle">Select the plan that matches your current skill level</p>
            
            <div class="plans-grid">
              <!-- Beginner Plan Card -->
              <div class="plan-card beginner-card">
                <div class="plan-level-badge"><i class="fa-solid fa-seedling"></i> Beginner</div>
                <h3 class="plan-title">{{ dualBlueprint()?.beginnerPlan?.activityTitle }}</h3>
                <p class="plan-description">{{ dualBlueprint()?.beginnerPlan?.activityDescription }}</p>
                
                <div class="plan-timing">
                  <span class="timing-item">
                    <span class="timing-icon"><i class="fa-solid fa-stopwatch"></i></span>
                    {{ dualBlueprint()?.beginnerPlan?.focusMinutes }}m focus
                  </span>
                  <span class="timing-item">
                    <span class="timing-icon"><i class="fa-solid fa-mug-hot"></i></span>
                    {{ dualBlueprint()?.beginnerPlan?.breakMinutes }}m break
                  </span>
                </div>
                
                <div class="plan-todos">
                  <h4>To-Do List</h4>
                  <ul>
                    @for (todo of dualBlueprint()?.beginnerPlan?.todos; track todo) {
                      <li>{{ todo }}</li>
                    }
                  </ul>
                </div>
                
                <div class="plan-tip">
                  <span class="tip-icon"><i class="fa-solid fa-lightbulb"></i></span>
                  <span class="tip-text">{{ dualBlueprint()?.beginnerPlan?.tipNote }}</span>
                </div>
                
                <button type="button" class="btn-accept" (click)="acceptPlan('beginner')">
                  Accept & Start
                </button>
              </div>
              
              <!-- Intermediate Plan Card -->
              <div class="plan-card intermediate-card">
                <div class="plan-level-badge"><i class="fa-solid fa-rocket"></i> Intermediate</div>
                <h3 class="plan-title">{{ dualBlueprint()?.intermediatePlan?.activityTitle }}</h3>
                <p class="plan-description">{{ dualBlueprint()?.intermediatePlan?.activityDescription }}</p>
                
                <div class="plan-timing">
                  <span class="timing-item">
                    <span class="timing-icon"><i class="fa-solid fa-stopwatch"></i></span>
                    {{ dualBlueprint()?.intermediatePlan?.focusMinutes }}m focus
                  </span>
                  <span class="timing-item">
                    <span class="timing-icon"><i class="fa-solid fa-mug-hot"></i></span>
                    {{ dualBlueprint()?.intermediatePlan?.breakMinutes }}m break
                  </span>
                </div>
                
                <div class="plan-todos">
                  <h4>To-Do List</h4>
                  <ul>
                    @for (todo of dualBlueprint()?.intermediatePlan?.todos; track todo) {
                      <li>{{ todo }}</li>
                    }
                  </ul>
                </div>
                
                <div class="plan-tip">
                  <span class="tip-icon"><i class="fa-solid fa-lightbulb"></i></span>
                  <span class="tip-text">{{ dualBlueprint()?.intermediatePlan?.tipNote }}</span>
                </div>
                
                <button type="button" class="btn-accept" (click)="acceptPlan('intermediate')">
                  Accept & Start
                </button>
              </div>
            </div>
            
            <div class="wizard-actions">
              <button type="button" class="btn-magic" (click)="generateAgain()">
                <span class="magic-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></span> Generate Again
              </button>
              <button type="button" class="btn-secondary" (click)="close()">Cancel</button>
            </div>
          </div>
        }
        
        @case ('confirming') {
          <div class="generating-state">
            <div class="loading-spinner"></div>
            <p class="generating-text">Setting up your activity...</p>
          </div>
        }
        
        @case ('error') {
          <div class="error-state">
            <p class="error">{{ error() }}</p>
            <button type="button" class="btn-secondary" (click)="close()">Close</button>
          </div>
        }
      }
    </div>
  </div>
}
