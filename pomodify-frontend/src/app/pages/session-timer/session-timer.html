<div class="session-timer-page" 
     [attr.data-phase]="currentPhase()"
     [style.--activity-color]="activityColor()">
  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin"></i>
      <p>Loading session...</p>
    </div>
  }

  <!-- Error State -->
  @else if (error()) {
    <div class="error-container">
      <i class="fa-solid fa-exclamation-circle"></i>
      <p>{{ error() }}</p>
      <button class="btn-primary" (click)="goBack()">Go Back</button>
    </div>
  }

  <!-- Main Timer Interface -->
  @else if (session(); as sess) {
    <div class="container">
      <!-- Header -->
      <header class="session-header">
        <button class="btn-back" (click)="goBack()">
          <i class="fa-solid fa-arrow-left"></i>
          <span>Back</span>
        </button>
        <h1 class="activity-title">{{ activityTitle() }}</h1>
      </header>

      <!-- Main Content: Timer and Notes Side by Side -->
      <div class="main-content-wrapper">
        <!-- Left Side: Timer Circle -->
        <div class="timer-section">
          <!-- Mascot Character - Companion beside timer -->
          <div class="mascot-container" 
               [class.celebrating]="isCompleted()"
               [class.bouncing]="isRunning()"
               [class.idle]="isNotStarted() || isPaused()"
               [class.shake]="isTimeLow()">
            <img src="/assets/images/pomodify-mascoot.png" 
                 alt="Pomodify Mascot" 
                 class="mascot-character"
                 [class.focus-mode]="currentPhase() === 'FOCUS'"
                 [class.break-mode]="currentPhase() === 'BREAK'">
            <!-- Speech bubble for motivation -->
            <div class="mascot-bubble" 
                 [class.show]="isRunning()">
              @if (currentPhase() === 'FOCUS') {
                <span>Stay Focused! ðŸŽ¯</span>
              } @else {
                <span>Enjoy Your Break! ðŸŒŸ</span>
              }
            </div>
          </div>

          <div class="timer-circle">
            <!-- Top: Session Type and Progress -->
            <div class="timer-top">
              <span class="session-type">{{ sessionTypeDisplay() }}</span>
              @if (isFreestyle() && longBreakIntervalDisplay(); as lbInterval) {
                <span class="cycle-indicator" title="Cycles until long break">
                  <i class="fa-solid fa-coffee"></i>
                  {{ lbInterval.display }}
                </span>
              } @else {
                <span class="cycle-indicator">#{{ cycleDisplay() }}</span>
              }
            </div>

            <!-- Long Break Interval Editor removed - now in time picker modal -->

            <!-- Focus/Break Labels with Time Info -->
            <div class="phase-labels">
              @if (!isFreestyle() || (isFreestyle() && currentPhase() === 'FOCUS')) {
                <span 
                  class="phase-label" 
                  [class.active]="currentPhase() === 'FOCUS'"
                  [class.clickable]="(isNotStarted() || isPaused()) && !isFreestyle()"
                  (click)="switchToPhase('FOCUS')">
                  Focus
                </span>
              }
              @if (!isFreestyle() || (isFreestyle() && currentPhase() === 'BREAK')) {
                <span 
                  class="phase-label" 
                  [class.active]="currentPhase() === 'BREAK'"
                  [class.clickable]="(isNotStarted() || isPaused()) && !isFreestyle()"
                  (click)="switchToPhase('BREAK')">
                  Break
                </span>
              }
            </div>

            <!-- Timer Display (clickable to edit only for Freestyle) -->
            <div class="timer-display-box" 
                 [class.clickable]="canEditTimer()" 
                 [class.classic-locked]="!isFreestyle()"
                 (click)="openTimePicker()">
              <div class="time-value">
                <span class="timer-digit" [class.editable]="canEditTimer()">{{ minutesDisplay() }}</span>
                <span class="timer-separator">:</span>
                <span class="timer-digit" [class.editable]="canEditTimer()">{{ secondsDisplay() }}</span>
              </div>
              
              @if (canEditTimer()) {
                <i class="fa-solid fa-pen-to-square edit-icon"></i>
              }
              @if (!isFreestyle() && (isNotStarted() || isPaused())) {
                <i class="fa-solid fa-lock locked-icon" title="Classic sessions have fixed durations"></i>
              }
            </div>




            <!-- Timer Controls - Different layouts based on state -->
            <div class="timer-controls">
              <!-- NOT_STARTED State -->
              @if (isNotStarted()) {
                <button 
                  type="button"
                  class="btn-icon btn-start"
                  (click)="confirmAndStartSession()"
                  title="Start">
                  <i class="fa-solid fa-play"></i>
                </button>
                @if (isFreestyle()) {
                  <button 
                    type="button"
                    class="btn-icon btn-skip"
                    (click)="skipPhase()"
                    title="Skip to next phase">
                    <i class="fa-solid fa-forward-step"></i>
                  </button>
                } @else {
                  <button 
                    type="button"
                    class="btn-icon btn-stop"
                    (click)="abandonSession()"
                    title="Abandon session">
                    <i class="fa-solid fa-stop"></i>
                  </button>
                }
              }

              <!-- IN_PROGRESS State -->
              @if (isRunning()) {
                <button 
                  type="button"
                  class="btn-icon btn-pause"
                  (click)="pauseSession()"
                  title="Pause">
                  <i class="fa-solid fa-pause"></i>
                </button>
                <button 
                  type="button"
                  class="btn-icon btn-stop"
                  (click)="abandonSession()"
                  title="Abandon session">
                  <i class="fa-solid fa-stop"></i>
                </button>
                @if (isFreestyle()) {
                  <button 
                    type="button"
                    class="btn-icon btn-skip"
                    (click)="skipPhase()"
                    title="Skip to next phase">
                    <i class="fa-solid fa-forward-step"></i>
                  </button>
                }
              }

              <!-- PAUSED State -->
              @if (isPaused()) {
                @if (isFreestyle()) {
                  @if (showStartButton()) {
                    <button 
                      type="button"
                      class="btn-icon btn-start"
                      (click)="startPhase()"
                      title="Start">
                      <i class="fa-solid fa-play"></i>
                    </button>
                  } @else {
                    <button 
                      type="button"
                      class="btn-icon btn-resume"
                      (click)="resumeSessionAction()"
                      title="Resume">
                      <i class="fa-solid fa-play"></i>
                    </button>
                  }
                  @if (!hasBeenReset()) {
                    <button 
                      type="button"
                      class="btn-icon btn-reset"
                      (click)="resetSession()"
                      title="Reset session">
                      <i class="fa-solid fa-rotate-left"></i>
                    </button>
                  } @else {
                    <button 
                      type="button"
                      class="btn-icon btn-stop"
                      (click)="abandonSession()"
                      title="Abandon session">
                      <i class="fa-solid fa-stop"></i>
                    </button>
                  }
                  <button 
                    type="button"
                    class="btn-icon btn-skip"
                    (click)="skipPhase()"
                    title="Skip to next phase">
                    <i class="fa-solid fa-forward-step"></i>
                  </button>
                } @else {
                  <button 
                    type="button"
                    class="btn-icon btn-resume"
                    (click)="resumeSessionAction()"
                    title="Resume">
                    <i class="fa-solid fa-play"></i>
                  </button>
                  <button 
                    type="button"
                    class="btn-icon btn-reset"
                    (click)="resetSession()"
                    title="Reset session">
                    <i class="fa-solid fa-rotate-left"></i>
                  </button>
                }
              }
            </div>

            <!-- Complete Session Button (Freestyle only, shown when running or paused) -->
            @if (isFreestyle() && (isRunning() || isPaused())) {
              <div class="complete-session-section">
                <button 
                  type="button"
                  class="btn-icon btn-complete"
                  (click)="completeSession()"
                  title="Complete session">
                  <i class="fa-solid fa-check"></i>
                </button>
              </div>
            }
          </div>
        </div>

        <!-- Right Side: Notes and Todo Panel (hidden for ABANDONED sessions) -->
        @if (!isAbandoned()) {
        <div class="notes-panel" [class.read-only]="isCompleted()">
          <!-- Header: Notes label and TODO button -->
          <div class="panel-header">
            <span class="notes-label">Notes:</span>
            @if (isCompleted()) {
              <span class="read-only-badge">
                <i class="fa-solid fa-lock"></i>
                Read Only
              </span>
            }
            <div class="header-actions">
              @if (!isCompleted()) {
                <button 
                  class="btn-ai-suggest" 
                  (click)="generateAiTodos()"
                  [disabled]="isGeneratingAi()"
                  title="AI will suggest todos based on your activity and previous sessions">
                  @if (isGeneratingAi()) {
                    <i class="fa-solid fa-spinner fa-spin"></i>
                  } @else {
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                  }
                </button>
                <button class="btn-add-todo" (click)="addTodo()">
                  <span class="todo-label">TODO</span>
                  <i class="fa-solid fa-plus"></i>
                </button>
              }
            </div>
          </div>

          <!-- Todo List -->
          <div class="todo-list">
            @for (todo of todos(); track todo.id) {
              <div class="todo-item" [class.todo-done]="todo.done">
                <input 
                  type="checkbox" 
                  class="todo-checkbox"
                  [checked]="todo.done"
                  (change)="toggleTodo(todo.id)"
                  [disabled]="isCompleted()"
                  [id]="'todo-' + todo.id">
                <input 
                  type="text"
                  class="todo-text"
                  [class.todo-checked]="todo.done"
                  [value]="todo.text"
                  (input)="updateTodoText(todo.id, $any($event.target).value)"
                  [readonly]="isCompleted()"
                  [id]="'todo-text-' + todo.id"
                  placeholder="Todo item">
                @if (!isCompleted()) {
                  <button 
                    class="btn-remove-todo"
                    (click)="removeTodo(todo.id)"
                    title="Remove">
                    <i class="fa-solid fa-x"></i>
                  </button>
                }
              </div>
            }
          </div>

          <!-- Notes Textarea at Bottom -->
          <textarea 
            class="notes-textarea"
            [value]="notes"
            (input)="onNotesChanged($event)"
            (blur)="saveNotes()"
            [readonly]="isCompleted()"
            placeholder="Add your notes here..."></textarea>
        </div>
        }
      </div>
    </div>
  }

  <!-- Auto-Start Countdown - Desktop: Toast, Mobile: Modal -->
  @if (showAutoStartCountdown()) {
    <div class="auto-start-notification" [class.mobile-modal]="isMobile()">
      @if (isMobile()) {
        <!-- Mobile: Full Modal -->
        <div class="auto-start-overlay">
          <div class="auto-start-modal">
            <div class="auto-start-header">
              <i class="fa-solid fa-play-circle auto-start-icon"></i>
              <h3 class="auto-start-title">Auto-Starting Next Phase</h3>
            </div>
            
            <div class="auto-start-body">
              <div class="countdown-circle">
                <span class="countdown-number">{{ autoStartCountdown() }}</span>
              </div>
              <p class="auto-start-message">
                The next phase will start automatically in {{ autoStartCountdown() }} second{{ autoStartCountdown() === 1 ? '' : 's' }}
              </p>
            </div>
            
            <div class="auto-start-actions">
              <button class="btn-cancel-auto-start" (click)="cancelAutoStart()">
                <i class="fa-solid fa-times"></i>
                Cancel Auto-Start
              </button>
            </div>
          </div>
        </div>
      } @else {
        <!-- Desktop: Toast Notification -->
        <div class="auto-start-toast">
          <div class="toast-content">
            <div class="toast-icon">
              <i class="fa-solid fa-play-circle"></i>
            </div>
            <div class="toast-info">
              <h4 class="toast-title">Auto-Starting Next Phase</h4>
              <p class="toast-message">Starting in {{ autoStartCountdown() }}s</p>
            </div>
            <div class="toast-countdown">
              <div class="countdown-ring">
                <span class="countdown-number">{{ autoStartCountdown() }}</span>
              </div>
            </div>
            <button class="toast-cancel" (click)="cancelAutoStart()" title="Cancel Auto-Start">
              <i class="fa-solid fa-times"></i>
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>
