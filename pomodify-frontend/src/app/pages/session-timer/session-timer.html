<div class="session-timer-page" [attr.data-phase]="currentPhase()">
  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <i class="fa-solid fa-spinner fa-spin"></i>
      <p>Loading session...</p>
    </div>
  }

  <!-- Error State -->
  @else if (error()) {
    <div class="error-container">
      <i class="fa-solid fa-exclamation-circle"></i>
      <p>{{ error() }}</p>
      <button class="btn-primary" (click)="goBack()">Go Back</button>
    </div>
  }

  <!-- Main Timer Interface -->
  @else if (session(); as sess) {
    <div class="container">
      <!-- Header -->
      <header class="session-header">
        <button class="btn-back" (click)="goBack()">
          <i class="fa-solid fa-arrow-left"></i>
          <span>Back</span>
        </button>
        <h1 class="activity-title">{{ activityTitle() }}</h1>
      </header>

      <!-- Main Content: Timer and Notes Side by Side -->
      <div class="main-content-wrapper">
        <!-- Left Side: Timer Circle -->
        <div class="timer-section">
          <!-- Mascot Character - Companion beside timer -->
          <div class="mascot-container" 
               [class.celebrating]="isCompleted()"
               [class.bouncing]="isRunning()"
               [class.idle]="isPending() || isPaused()"
               [class.shake]="isTimeLow()">
            <img src="/assets/images/pomodify-mascoot.png" 
                 alt="Pomodify Mascot" 
                 class="mascot-character"
                 [class.focus-mode]="currentPhase() === 'FOCUS'"
                 [class.break-mode]="currentPhase() === 'BREAK'">
            <!-- Speech bubble for motivation -->
            <div class="mascot-bubble" 
                 [class.show]="isRunning()">
              @if (currentPhase() === 'FOCUS') {
                <span>Stay Focused! ðŸŽ¯</span>
              } @else {
                <span>Enjoy Your Break! ðŸŒŸ</span>
              }
            </div>
          </div>

          <div class="timer-circle">
            <!-- Top: Session Type and Progress -->
            <div class="timer-top">
              <span class="session-type">{{ sessionTypeDisplay() }}</span>
              <span class="cycle-indicator">#{{ cycleDisplay() }}</span>
            </div>

            <!-- Focus/Break Labels with Time Info -->
            <div class="phase-labels">
              @if (!isFreestyle() || (isFreestyle() && currentPhase() === 'FOCUS')) {
                <span 
                  class="phase-label" 
                  [class.active]="currentPhase() === 'FOCUS'"
                  [class.clickable]="(isPending() || isPaused()) && !isFreestyle()"
                  (click)="switchToPhase('FOCUS')">
                  Focus
                </span>
              }
              @if (!isFreestyle() || (isFreestyle() && currentPhase() === 'BREAK')) {
                <span 
                  class="phase-label" 
                  [class.active]="currentPhase() === 'BREAK'"
                  [class.clickable]="(isPending() || isPaused()) && !isFreestyle()"
                  (click)="switchToPhase('BREAK')">
                  Break
                </span>
              }
            </div>

            <!-- Timer Display (clickable to edit) -->
            <div 
              class="timer-display-box" 
              [class.clickable]="session()?.status !== 'COMPLETED'"
              (click)="openTimePicker()"
              title="Click to edit timer">
              <div class="time-value">{{ timerDisplay() }}</div>
              @if (session()?.status !== 'COMPLETED') {
                <i class="fa-solid fa-pen-to-square edit-icon"></i>
              }
            </div>

            <!-- Start/Pause and Stop Buttons -->
            <div class="timer-controls">
              <button 
                class="btn-timer-control"
                [class.paused]="isPaused()"
                (click)="isRunning() ? pauseSession() : startSession()">
                @if (isRunning()) {
                  PAUSE
                } @else {
                  START
                }
              </button>
              @if (isRunning() || isPaused()) {
                <button 
                  class="btn-stop"
                  (click)="stopSession()"
                  title="Stop and reset timer">
                  STOP
                </button>
              }
              @if (isFreestyle()) {
                <button 
                  class="btn-fast-forward"
                  (click)="fastForwardPhase()"
                  title="Fast forward to next phase">
                  <i class="fa-solid fa-forward-fast"></i>
                </button>
              }

            </div>

            <!-- Early Complete Button (shown only when running or paused) -->
            @if (isRunning() || isPaused()) {
              <div class="early-complete-section">
                <button 
                  class="btn-early-complete"
                  (click)="completeSessionEarly()"
                  title="Complete session early">
                  <i class="fa-solid fa-check-circle"></i>
                  Complete Early
                </button>
              </div>
            }
          </div>
        </div>

        <!-- Right Side: Notes and Todo Panel -->
        <div class="notes-panel">
          <!-- Header: Notes label and TODO button -->
          <div class="panel-header">
            <span class="notes-label">Notes:</span>
            <button class="btn-add-todo" (click)="addTodo()">
              <span class="todo-label">TODO</span>
              <i class="fa-solid fa-plus"></i>
            </button>
          </div>

          <!-- Todo List -->
          <div class="todo-list">
            @for (todo of todos(); track todo.id) {
              <div class="todo-item">
                <input 
                  type="checkbox" 
                  class="todo-checkbox"
                  [checked]="todo.checked"
                  (change)="toggleTodo(todo.id)"
                  [id]="'todo-' + todo.id">
                <input 
                  type="text"
                  class="todo-text"
                  [value]="todo.text"
                  (input)="updateTodoText(todo.id, $any($event.target).value)"
                  [id]="'todo-text-' + todo.id"
                  placeholder="Todo item">
                <button 
                  class="btn-remove-todo"
                  (click)="removeTodo(todo.id)"
                  title="Remove">
                  <i class="fa-solid fa-x"></i>
                </button>
              </div>
            }
          </div>

          <!-- Notes Textarea at Bottom -->
          <textarea 
            class="notes-textarea"
            [value]="notes"
            (input)="onNotesChanged($event)"
            (blur)="saveNotes()"
            placeholder="Add your notes here..."></textarea>
        </div>
      </div>
    </div>
  }
</div>
