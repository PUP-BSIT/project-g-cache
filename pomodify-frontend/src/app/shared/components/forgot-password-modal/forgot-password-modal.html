<div class="forgot-password-container">
  <h2 mat-dialog-title>Reset Password</h2>
  
  <div mat-dialog-content>
    <!-- Step 1: Enter Email -->
    @if (currentStep() === 'email') {
      <p class="description">Enter your email address and we'll send you a link to reset your password.</p>
      
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" placeholder="Enter your email" type="email">
          <mat-error *ngIf="form.get('email')?.hasError('required')">Email is required</mat-error>
          <mat-error *ngIf="form.get('email')?.hasError('email')">Please enter a valid email</mat-error>
        </mat-form-field>
      </form>

      <button 
        type="button" 
        class="cant-access-link" 
        (click)="onCantAccessEmail()" 
        [disabled]="form.invalid || isLoading()">
        I can't access my email right now
      </button>
    }

    <!-- Step 2: Backup Email Option -->
    @if (currentStep() === 'backup-option') {
      <div class="backup-option-container">
        <div class="info-icon">
          <i class="fas fa-envelope-open-text"></i>
        </div>
        <h3>Use Backup Email?</h3>
        <p>We found a backup email associated with your account:</p>
        <p class="masked-email"><strong>{{ maskedBackupEmail() }}</strong></p>
        <p class="helper-text">We can send the password reset link to this email instead.</p>
      </div>
    }

    <!-- Step 3: Enter Backup Email -->
    @if (currentStep() === 'backup-email-input') {
      <div class="backup-email-input-container">
        <p class="description">Enter your backup email address to receive the password reset link.</p>
        
        <form [formGroup]="backupEmailForm" (ngSubmit)="onSubmitBackupEmail()">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Backup Email</mat-label>
            <input matInput formControlName="backupEmail" placeholder="Enter your backup email" type="email">
            <mat-error *ngIf="backupEmailForm.get('backupEmail')?.hasError('required')">Backup email is required</mat-error>
            <mat-error *ngIf="backupEmailForm.get('backupEmail')?.hasError('email')">Please enter a valid email</mat-error>
          </mat-form-field>
        </form>
      </div>
    }

    <!-- Step 4: No Backup Email - Prompt to Add -->
    @if (currentStep() === 'add-backup-email') {
      <div class="no-backup-container">
        <div class="warning-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3>No Backup Email Found</h3>
        <p>You haven't set up a backup email for your account yet.</p>
        <p class="helper-text">
          To recover your account without access to your primary email, you'll need to add a backup email first. 
          Please log in to your account when you have access to your primary email and add a backup email in your profile settings.
        </p>
        <p class="alternative-text">
          Alternatively, if you can access your primary email, click "Back" and use the standard password reset.
        </p>
      </div>
    }

    <!-- Step 5: Success -->
    @if (currentStep() === 'success') {
      <div class="success-message">
        <div class="icon-circle">
          <i class="fas fa-check"></i>
        </div>
        <h3>Check your email</h3>
        <p>We have sent a password reset link to <strong>{{ sentToEmail() }}</strong>.</p>
      </div>
    }
  </div>

  <div mat-dialog-actions align="end">
    @if (currentStep() === 'email') {
      <button mat-button (click)="onClose()">Cancel</button>
      <button mat-flat-button color="primary" (click)="onSubmit()" [disabled]="form.invalid || isLoading()">
        {{ isLoading() ? 'Sending...' : 'Send Reset Link' }}
      </button>
    }

    @if (currentStep() === 'backup-option') {
      <button mat-button (click)="onBackToEmail()">Back</button>
      <button mat-flat-button color="primary" (click)="onUseBackupEmail()">
        Use Backup Email
      </button>
    }

    @if (currentStep() === 'backup-email-input') {
      <button mat-button (click)="onBackToEmail()">Back</button>
      <button mat-flat-button color="primary" (click)="onSubmitBackupEmail()" [disabled]="backupEmailForm.invalid || isLoading()">
        {{ isLoading() ? 'Sending...' : 'Send Reset Link' }}
      </button>
    }

    @if (currentStep() === 'add-backup-email') {
      <button mat-button (click)="onBackToEmail()">Back</button>
      <button mat-flat-button color="primary" (click)="onClose()">
        Got it
      </button>
    }

    @if (currentStep() === 'success') {
      <button mat-flat-button color="primary" (click)="onClose()">Close</button>
    }
  </div>
</div>
