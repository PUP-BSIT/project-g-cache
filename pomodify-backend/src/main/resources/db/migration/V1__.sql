-- =====================================================
-- V1 Baseline Migration - Creates all core tables
-- Tables are created in dependency order (parent tables first)
-- =====================================================

-- 1. app_user (no dependencies)
CREATE TABLE app_user (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    is_email_verified BOOLEAN NOT NULL DEFAULT FALSE,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    auth_provider VARCHAR(255) NOT NULL DEFAULT 'LOCAL' CHECK (auth_provider IN ('LOCAL', 'GOOGLE')),
    created_at TIMESTAMP(6),
    updated_at TIMESTAMP(6)
);

-- 2. category (depends on app_user)
CREATE TABLE category (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    user_id BIGINT NOT NULL,
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
    CONSTRAINT fk_category_user FOREIGN KEY (user_id) REFERENCES app_user(id)
);

-- 3. activity (depends on app_user, category)
CREATE TABLE activity (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    user_id BIGINT NOT NULL,
    category_id BIGINT,
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP(6),
    updated_at TIMESTAMP(6),
    CONSTRAINT fk_activity_user FOREIGN KEY (user_id) REFERENCES app_user(id),
    CONSTRAINT fk_activity_category FOREIGN KEY (category_id) REFERENCES category(id)
);

-- 4. pomodoro_session (depends on activity)
CREATE TABLE pomodoro_session (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    session_type VARCHAR(255) NOT NULL CHECK (session_type IN ('CLASSIC', 'FREESTYLE')),
    status VARCHAR(255) CHECK (status IN ('NOT_STARTED', 'IN_PROGRESS', 'COMPLETED', 'PAUSED', 'ABANDONED')),
    focus_duration NUMERIC(21,0) NOT NULL,
    break_duration NUMERIC(21,0) NOT NULL,
    long_break_duration NUMERIC(21,0),
    long_break_interval NUMERIC(21,0),
    total_cycles INTEGER,
    current_phase VARCHAR(255) CHECK (current_phase IN ('FOCUS', 'BREAK', 'LONG_BREAK')),
    activity_id BIGINT,
    started_at TIMESTAMP(6),
    completed_at TIMESTAMP(6),
    phase_started_at TIMESTAMP(6),
    total_paused_duration_seconds BIGINT DEFAULT 0,
    cycles_completed INTEGER NOT NULL DEFAULT 0,
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP(6),
    updated_at TIMESTAMP(6),
    CONSTRAINT fk_session_activity FOREIGN KEY (activity_id) REFERENCES activity(id)
);

-- 5. pomodoro_settings (depends on app_user)
CREATE TABLE pomodoro_settings (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL UNIQUE,
    work_duration_minutes INTEGER NOT NULL,
    short_break_minutes INTEGER NOT NULL,
    long_break_minutes INTEGER NOT NULL,
    sessions_until_long_break INTEGER NOT NULL,
    auto_start_breaks BOOLEAN NOT NULL DEFAULT FALSE,
    auto_start_sessions BOOLEAN NOT NULL DEFAULT FALSE,
    CONSTRAINT fk_settings_user FOREIGN KEY (user_id) REFERENCES app_user(id)
);

-- 6. session_note (depends on pomodoro_session)
CREATE TABLE session_note (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    pomodoro_session_id BIGINT NOT NULL UNIQUE,
    content TEXT NOT NULL DEFAULT '',
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP(6) NOT NULL,
    updated_at TIMESTAMP(6) NOT NULL,
    CONSTRAINT fk_note_session FOREIGN KEY (pomodoro_session_id) REFERENCES pomodoro_session(id)
);

-- 7. session_todo_item (depends on session_note)
CREATE TABLE session_todo_item (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note_id BIGINT NOT NULL,
    text VARCHAR(255) NOT NULL,
    done BOOLEAN NOT NULL DEFAULT FALSE,
    order_index INTEGER,
    CONSTRAINT fk_todo_note FOREIGN KEY (note_id) REFERENCES session_note(id)
);

-- 8. revoked_tokens (no dependencies)
CREATE TABLE revoked_tokens (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    token VARCHAR(255) NOT NULL UNIQUE,
    revoked_at TIMESTAMP(6)
);

-- 9. user_push_token (no dependencies - uses user_id as value, not FK)
CREATE TABLE user_push_token (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL UNIQUE,
    token VARCHAR(512) NOT NULL,
    enabled BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP(6),
    updated_at TIMESTAMP(6)
);

-- 10. user_settings (uses user_id as PK)
CREATE TABLE user_settings (
    user_id BIGINT PRIMARY KEY,
    sound_type VARCHAR(255) CHECK (sound_type IN ('BELL', 'CHYME', 'DIGITAL_BEEP', 'SOFT_DING')),
    notification_sound BOOLEAN NOT NULL DEFAULT TRUE,
    volume INTEGER NOT NULL DEFAULT 70,
    auto_start_breaks BOOLEAN NOT NULL DEFAULT FALSE,
    auto_start_pomodoros BOOLEAN NOT NULL DEFAULT FALSE,
    theme VARCHAR(255) CHECK (theme IN ('LIGHT', 'DARK', 'SYSTEM')),
    notifications_enabled BOOLEAN NOT NULL DEFAULT TRUE,
    updated_at TIMESTAMP(6) WITH TIME ZONE
);

-- 11. user_badge (no FK, uses user_id as value)
CREATE TABLE user_badge (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    milestone_days INTEGER NOT NULL,
    date_awarded DATE NOT NULL,
    CONSTRAINT unique_user_milestone UNIQUE (user_id, milestone_days)
);

-- 12. verification_token (depends on app_user)
CREATE TABLE verification_token (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    token VARCHAR(255),
    expiry_date TIMESTAMP(6),
    user_id BIGINT NOT NULL UNIQUE,
    CONSTRAINT fk_verification_user FOREIGN KEY (user_id) REFERENCES app_user(id)
);
